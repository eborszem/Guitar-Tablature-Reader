<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.2/Tone.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> -->
    
    <link rel="stylesheet" th:href="@{/css/page.css}">
    <script type="text/javascript" th:src="@{/js/page.js}"></script>
    <script type="text/javascript" th:src="@{/js/testingsound.js}"></script>
</head>
<body>
    <div class="interface">
        <p class="title">TAB READER</p>
        <div class="button-container">
            <button id="add-new-measure" class="button">Add measure</button>
            <button id="add-chord" class="button">Add chord</button>
            <button id="play-btn" class="button">Play</button>
        </div>
        <!--note in chord in measure in composition-->
        <!--<p th:text="${measure}">Default text</p>-->
        <!--currently trying to print out all the notes in the first chord of the composition-->
        <!--<li th:each="note : ${composition.measure.chord.allNotes}" th:text="${note.interval}"></li>-->
        
        <div class="composition-box">
            <div th:each="measure1, measureStat : ${measure.allMeasures}">
                <!-- <p th:text="'measure = ' + ${measure1}"></p> -->
                <!-- <p>1</p> -->
                <div class="measure-box">
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div th:each="chord1, chord1stat : ${measure1.allChords}">
                        <!-- <p class = "chord-name"th:text="'chord = ' + ${chord1}"></p> -->
                        <div class="chord-box" th:id="'measure' + ${measureStat.index} + 'chord' + ${chord1stat.index}" th:onclick="'chordClicked(' + ${measureStat.index} + ','+ ${chord1stat.index} + ')'">
                            <div th:each="note1 : ${chord1.allNotes}">
                                <p class="note">
                                    <span th:text="${note1.fretNumber}"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chordModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p id="notesDisplay"></p>
            </div>
        </div>

    </div>
    
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            $(document).ready(function() {
                $.ajax({
                    url: '/play',
                    method: 'GET',
                    success: function(chords) {
                        play(chords);
                    },
                    error: function(error) {
                        console.log('Error:', error);
                    }
                });
        
                function play(chords) {
                    console.log(chords)
                    const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    // Define note values
                    const WHOLE_NOTE = 4;
                    const HALF_NOTE = 2;
                    const QUARTER_NOTE = 1;
                    const EIGHTH_NOTE = .5;
                    const SIXTEENTH_NOTE = .25;
                    // Now there is a way to convert from fretboard[string][fret] to a specific chord and pitch
                    // May pad the fretboard with an empty string to make it 1-indexed
                    const FRETBOARD = [
                        ["E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5", "C#5", "D5", "D#5"],
                        ["B3", "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4"],
                        ["G3", "G#3", "A3", "A#3", "B3", "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4"],
                        ["D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3", "C4", "C#4"],
                        ["A2", "A#2", "B2", "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3"],
                        ["E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2", "C3", "C#3", "D3", "D#3"],
                    ]

                    // An array which will be passed as a parameter
                    const array = [];

                    let t = 0;
                    for (let i = 0; i < chords.length; i++) {
                        let chordData = chords[i];
                        console.log("TEST--chords[0]=");
                        console.log(chords[0]);
                        let dur = chordData[0][2];  // first note dur = every note dur
                        if (dur == 50)
                            dur = .5
                        if (dur == 25)
                            dur = .25
                        if (dur == 125)
                            dur = .125
                        let str = getDurationAsString(dur);

                        //let chordArray = getChord(chordData);
                        
                        let chordArray = [];
                        console.log("len="+chords[i].length);
                        console.log("len="+chordData.length);
                        for (let i = 0; i < chordData.length; i++) {
                            let string = chordData[i][1];
                            let fret = chordData[i][0];
                            console.log("str=" + string + ", fret=" + fret);
                            chordArray.push(FRETBOARD[string - 1][fret]);  // STRINGS ARE ZERO BASED
                        }
                        console.log("chord array=" + chordArray)

                        array.push({
                        time: `0:${t}`, 
                        chord: chordArray,
                        duration: str
                        });
                        t += (dur * .9)
                    }

                    /*function getChord(notes) {
                        console.log("notes..."+notes)
                        let chordArray = [];
                        for (let i = 0; i < notes.length; i++) {
                            let string = notes[i][1];
                            let fret = notes[i][0];
                            chordArray.push(FRETBOARD[string][fret]);
                        }
                        return chordArray;
                    }*/

                    function getDurationAsString(dur) {
                        switch (dur) {
                        case .125: return "32n";
                        case .25: return "16n";
                        case .5: return "8n";
                        case 1: return "4n";
                        case 2: return "2n";
                        case 4: return "1n";
                        default: return "4n"; // default to quarter note
                        }
                    }
                    
                    pianoPart = new Tone.Part(function(time, val) {
                        synth.triggerAttackRelease(val.chord, val.duration, time);  // 4n means play for quarter note duration. 2n -> half, 1n -> whole, etc
                    }, array);
                    console.log("final array=");
                    console.log(array);
                }
            });

            const playBtn = document.getElementById("play-btn");
            playBtn.addEventListener("click", async () => {
                await Tone.start();  // make sure audio is started
                Tone.Transport.start(); // start transport
                pianoPart.start(); // start part
            });

        })

        
    </script>

</body>
</html>
